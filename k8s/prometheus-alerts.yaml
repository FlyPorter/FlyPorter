apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: flyporter-alerts
  namespace: monitoring
  labels:
    app: flyporter
    prometheus: kube-prometheus
    role: alert-rules
    release: prometheus
spec:
  groups:
  - name: flyporter.rules
    # Demo-friendly interval; lower than default to speed up alert evaluation
    interval: 2s
    rules:
    # CPU Alerts - Pod Level
    # Using absolute CPU values: 70% of 500m limit = 350m = 0.35 cores
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="flyporter", pod=~"flyporter-backend.*"}[30s])) by (pod) > 0.35
      for: 3s
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High CPU usage on {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} CPU usage is above 70% for 5 minutes. Current: {{ $value | humanizePercentage }}"
    
    # Using absolute CPU values: 90% of 500m limit = 450m = 0.45 cores
    - alert: CriticalCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="flyporter", pod=~"flyporter-backend.*"}[30s])) by (pod) > 0.45
      for: 3s
      labels:
        severity: critical
        component: backend
      annotations:
        summary: "Critical CPU usage on {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} CPU usage is above 90% for 3 minutes. Current: {{ $value | humanizePercentage }}"
    
    # Memory Alerts - Pod Level
    - alert: HighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="flyporter", pod=~"flyporter-backend.*"}) by (pod) / 
        sum(container_spec_memory_limit_bytes{namespace="flyporter", pod=~"flyporter-backend.*"}) by (pod) > 0.75
      for: 5s
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High memory usage on {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} memory usage is above 75% for 5 minutes"
    
    - alert: CriticalMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="flyporter", pod=~"flyporter-backend.*"}) by (pod) / 
        sum(container_spec_memory_limit_bytes{namespace="flyporter", pod=~"flyporter-backend.*"}) by (pod) > 0.9
      for: 15s
      labels:
        severity: critical
        component: backend
      annotations:
        summary: "Critical memory usage on {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} memory usage is above 90% for 3 minutes"
    
    # Disk Alerts - Node Level
    - alert: HighDiskUsage
      expr: |
        (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.25
      for: 5m
      labels:
        severity: warning
        component: infrastructure
      annotations:
        summary: "High disk usage on node {{ $labels.instance }}"
        description: "Node {{ $labels.instance }} has less than 25% disk space available"
    
    - alert: CriticalDiskUsage
      expr: |
        (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
      for: 3m
      labels:
        severity: critical
        component: infrastructure
      annotations:
        summary: "Critical disk usage on node {{ $labels.instance }}"
        description: "Node {{ $labels.instance }} has less than 10% disk space available"
    
    # Node CPU Alerts
    - alert: HighNodeCPUUsage
      expr: |
        100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
      for: 5m
      labels:
        severity: warning
        component: infrastructure
      annotations:
        summary: "High CPU usage on node {{ $labels.instance }}"
        description: "Node {{ $labels.instance }} CPU usage is above 80% for 5 minutes"
    
    # Node Memory Alerts
    - alert: HighNodeMemoryUsage
      expr: |
        (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
      for: 5m
      labels:
        severity: warning
        component: infrastructure
      annotations:
        summary: "High memory usage on node {{ $labels.instance }}"
        description: "Node {{ $labels.instance }} memory usage is above 85% for 5 minutes"
    
    # Pod Restart Alerts
    - alert: PodRestarting
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="flyporter"}[15m]) > 0
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "Pod {{ $labels.pod }} is restarting frequently"
        description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes"
    
    - alert: PodCrashLoopBackOff
      expr: |
        kube_pod_container_status_waiting_reason{namespace="flyporter", reason="CrashLoopBackOff"} == 1
      for: 2m
      labels:
        severity: critical
        component: backend
      annotations:
        summary: "Pod {{ $labels.pod }} is in CrashLoopBackOff"
        description: "Pod {{ $labels.pod }} is crashing and restarting repeatedly"
    
    # HPA Scaling Alerts
    - alert: HPAAtMaxReplicas
      expr: |
        kube_horizontalpodautoscaler_status_current_replicas{namespace="flyporter"} == 
        kube_horizontalpodautoscaler_spec_max_replicas{namespace="flyporter"}
      for: 20s
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "HPA {{ $labels.horizontalpodautoscaler }} is at max replicas"
        description: "HPA has scaled to maximum replicas ({{ $value }}). Consider increasing max replicas or optimizing application."
    
    # Database Connection Alerts (if you add database metrics)
    - alert: DatabaseConnectionFailure
      expr: |
        up{job="postgres-exporter", namespace="flyporter"} == 0
      for: 2m
      labels:
        severity: critical
        component: database
      annotations:
        summary: "Database connection failure"
        description: "Cannot connect to database. Check database service and network connectivity."

